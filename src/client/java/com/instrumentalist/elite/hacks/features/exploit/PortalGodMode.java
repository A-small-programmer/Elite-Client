package com.instrumentalist.elite.hacks.features.exploit;

import com.instrumentalist.elite.events.features.ReceivedPacketEvent;
import com.instrumentalist.elite.events.features.SendPacketEvent;
import com.instrumentalist.elite.events.features.TickEvent;
import com.instrumentalist.elite.hacks.Module;
import com.instrumentalist.elite.hacks.ModuleCategory;
import com.instrumentalist.elite.utils.IMinecraft;
import com.instrumentalist.elite.utils.math.MSTimer;
import com.instrumentalist.elite.utils.packet.PacketUtil;
import net.minecraft.client.gui.screen.DownloadingTerrainScreen;
import net.minecraft.client.util.InputUtil;
import net.minecraft.network.packet.Packet;
import net.minecraft.network.packet.c2s.play.PlayerInteractBlockC2SPacket;
import net.minecraft.network.packet.c2s.play.TeleportConfirmC2SPacket;
import net.minecraft.network.packet.s2c.play.PlayerPositionLookS2CPacket;
import net.minecraft.util.hit.BlockHitResult;
import net.minecraft.util.math.Direction;
import org.lwjgl.glfw.GLFW;

public class PortalGodMode extends Module {

    public PortalGodMode() {
        super("Portal God Mode", ModuleCategory.Exploit, GLFW.GLFW_KEY_UNKNOWN, false, true);
    }

    private static Double teleportX = null;
    private static Double teleportY = null;
    private static Double teleportZ = null;
    private static boolean cancelTeleport = false;
    private final MSTimer portalTimer = new MSTimer();

    @Override
    public void onDisable() {
        teleportX = null;
        teleportY = null;
        teleportZ = null;
        cancelTeleport = false;
    }

    @Override
    public void onEnable() {
    }

    @Override
    public void onTick(TickEvent event) {
        if (IMinecraft.mc.player == null || IMinecraft.mc.player.age < 50) return;

        if (teleportX != null && teleportY != null && teleportZ != null && cancelTeleport) {
            IMinecraft.mc.player.setPosition(teleportX, teleportY, teleportZ);
            if (portalTimer.hasTimePassed(2500)) {
                cancelTeleport = false;
                portalTimer.reset();
            }
        }
    }

    @Override
    public void onReceivedPacket(ReceivedPacketEvent event) {
        if (IMinecraft.mc.player == null || IMinecraft.mc.player.age < 50) return;

        Packet<?> packet = event.packet;

        if (IMinecraft.mc.currentScreen instanceof DownloadingTerrainScreen && InputUtil.isKeyPressed(IMinecraft.mc.getWindow().getHandle(), GLFW.GLFW_KEY_LEFT_ALT)) {
            cancelTeleport = true;
            IMinecraft.mc.currentScreen = null;
            portalTimer.reset();
        }

        if (packet instanceof PlayerPositionLookS2CPacket) {
            teleportX = ((PlayerPositionLookS2CPacket) packet).change().position().getX();
            teleportY = ((PlayerPositionLookS2CPacket) packet).change().position().getY();
            teleportZ = ((PlayerPositionLookS2CPacket) packet).change().position().getZ();
            IMinecraft.mc.player.setPosition(((PlayerPositionLookS2CPacket) packet).change().position().x, ((PlayerPositionLookS2CPacket) packet).change().position().y, ((PlayerPositionLookS2CPacket) packet).change().position().z);
            event.cancel();
        }
    }
}
